/*
 * MailOdds Email Validation API
 *
 * MailOdds provides email validation services to help maintain clean email lists  and improve deliverability. The API performs multiple validation checks including  format verification, domain validation, MX record checking, and disposable email detection.  ## Authentication  All API requests require authentication using a Bearer token. Include your API key  in the Authorization header:  ``` Authorization: Bearer YOUR_API_KEY ```  API keys can be created in the MailOdds dashboard.  ## Rate Limits  Rate limits vary by plan: - Free: 10 requests/minute - Starter: 60 requests/minute   - Pro: 300 requests/minute - Business: 1000 requests/minute - Enterprise: Custom limits  ## Response Format  All responses include: - `schema_version`: API schema version (currently \"1.0\") - `request_id`: Unique request identifier for debugging  Error responses include: - `error`: Machine-readable error code - `message`: Human-readable error description 
 *
 * The version of the OpenAPI document: 1.0.0
 * Contact: support@mailodds.com
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;
using MailOdds.Api;
using MailOdds.Model;

namespace MailOdds.Client
{
    /// <summary>
    /// Provides hosting configuration for MailOdds
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();

        internal bool HttpClientsAdded { get; private set; }

        /// <summary>
        /// Instantiates the class 
        /// </summary>
        /// <param name="services"></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AddPolicyRule201ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AddSuppressionRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddSuppressionRequestEntriesInnerJsonConverter());
            _jsonOptions.Converters.Add(new AddSuppressionResponseJsonConverter());
            _jsonOptions.Converters.Add(new CheckSuppressionRequestJsonConverter());
            _jsonOptions.Converters.Add(new CreateJobFromS3RequestJsonConverter());
            _jsonOptions.Converters.Add(new CreateJobRequestJsonConverter());
            _jsonOptions.Converters.Add(new CreatePolicyFromPresetRequestJsonConverter());
            _jsonOptions.Converters.Add(new CreatePolicyRequestJsonConverter());
            _jsonOptions.Converters.Add(new DeleteJob200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new DeletePolicy200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new DeletePolicyRule200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ErrorResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetPresignedUploadRequestJsonConverter());
            _jsonOptions.Converters.Add(new HealthCheck200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new JobJsonConverter());
            _jsonOptions.Converters.Add(new JobListResponseJsonConverter());
            _jsonOptions.Converters.Add(new JobResponseJsonConverter());
            _jsonOptions.Converters.Add(new JobSummaryJsonConverter());
            _jsonOptions.Converters.Add(new PaginationJsonConverter());
            _jsonOptions.Converters.Add(new PolicyJsonConverter());
            _jsonOptions.Converters.Add(new PolicyListResponseJsonConverter());
            _jsonOptions.Converters.Add(new PolicyListResponseLimitsJsonConverter());
            _jsonOptions.Converters.Add(new PolicyPresetsResponseJsonConverter());
            _jsonOptions.Converters.Add(new PolicyPresetsResponsePresetsInnerJsonConverter());
            _jsonOptions.Converters.Add(new PolicyResponseJsonConverter());
            _jsonOptions.Converters.Add(new PolicyRuleJsonConverter());
            _jsonOptions.Converters.Add(new PolicyRuleActionJsonConverter());
            _jsonOptions.Converters.Add(new PolicyTestResponseJsonConverter());
            _jsonOptions.Converters.Add(new PresignedUploadResponseJsonConverter());
            _jsonOptions.Converters.Add(new PresignedUploadResponseUploadJsonConverter());
            _jsonOptions.Converters.Add(new RemoveSuppression200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new RemoveSuppressionRequestJsonConverter());
            _jsonOptions.Converters.Add(new ResultsResponseJsonConverter());
            _jsonOptions.Converters.Add(new SuppressionCheckResponseJsonConverter());
            _jsonOptions.Converters.Add(new SuppressionEntryJsonConverter());
            _jsonOptions.Converters.Add(new SuppressionListResponseJsonConverter());
            _jsonOptions.Converters.Add(new SuppressionStatsResponseJsonConverter());
            _jsonOptions.Converters.Add(new SuppressionStatsResponseByTypeJsonConverter());
            _jsonOptions.Converters.Add(new TelemetrySummaryJsonConverter());
            _jsonOptions.Converters.Add(new TelemetrySummaryRatesJsonConverter());
            _jsonOptions.Converters.Add(new TelemetrySummaryTopDomainsInnerJsonConverter());
            _jsonOptions.Converters.Add(new TelemetrySummaryTopReasonsInnerJsonConverter());
            _jsonOptions.Converters.Add(new TelemetrySummaryTotalsJsonConverter());
            _jsonOptions.Converters.Add(new TestPolicyRequestJsonConverter());
            _jsonOptions.Converters.Add(new TestPolicyRequestTestResultJsonConverter());
            _jsonOptions.Converters.Add(new UpdatePolicyRequestJsonConverter());
            _jsonOptions.Converters.Add(new ValidateRequestJsonConverter());
            _jsonOptions.Converters.Add(new ValidationResponseJsonConverter());
            _jsonOptions.Converters.Add(new ValidationResponseSuppressionMatchJsonConverter());
            _jsonOptions.Converters.Add(new ValidationResultJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
            _services.AddSingleton<BulkValidationApiEvents>();
            _services.AddSingleton<EmailValidationApiEvents>();
            _services.AddSingleton<SuppressionListsApiEvents>();
            _services.AddSingleton<SystemApiEvents>();
            _services.AddSingleton<ValidationPoliciesApiEvents>();
        }

        /// <summary>
        /// Configures the HttpClients.
        /// </summary>
        /// <param name="client"></param>
        /// <param name="builder"></param>
        /// <returns></returns>
        public HostConfiguration AddApiHttpClients
        (
            Action<HttpClient>? client = null, Action<IHttpClientBuilder>? builder = null)
        {
            if (client == null)
                client = c => c.BaseAddress = new Uri(ClientUtils.BASE_ADDRESS);

            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            builders.Add(_services.AddHttpClient<IBulkValidationApi, BulkValidationApi>(client));
            builders.Add(_services.AddHttpClient<IEmailValidationApi, EmailValidationApi>(client));
            builders.Add(_services.AddHttpClient<ISuppressionListsApi, SuppressionListsApi>(client));
            builders.Add(_services.AddHttpClient<ISystemApi, SystemApi>(client));
            builders.Add(_services.AddHttpClient<IValidationPoliciesApi, ValidationPoliciesApi>(client));
            
            if (builder != null)
                foreach (IHttpClientBuilder instance in builders)
                    builder(instance);

            HttpClientsAdded = true;

            return this;
        }

        /// <summary>
        /// Configures the JsonSerializerSettings
        /// </summary>
        /// <param name="options"></param>
        /// <returns></returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> options)
        {
            options(_jsonOptions);

            return this;
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="token"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(TTokenBase token) where TTokenBase : TokenBase
        {
            return AddTokens(new TTokenBase[]{ token });
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="tokens"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(IEnumerable<TTokenBase> tokens) where TTokenBase : TokenBase
        {
            TokenContainer<TTokenBase> container = new TokenContainer<TTokenBase>(tokens);
            _services.AddSingleton(services => container);

            return this;
        }

        /// <summary>
        /// Adds a token provider to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenProvider"></typeparam>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <returns></returns>
        public HostConfiguration UseProvider<TTokenProvider, TTokenBase>() 
            where TTokenProvider : TokenProvider<TTokenBase>
            where TTokenBase : TokenBase
        {
            _services.AddSingleton<TTokenProvider>();
            _services.AddSingleton<TokenProvider<TTokenBase>>(services => services.GetRequiredService<TTokenProvider>());

            return this;
        }
    }
}
